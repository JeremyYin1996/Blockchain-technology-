<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>第二十二节:ETH-智能合约</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	text-indent: -1.7em;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-opaquegray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="b03b539f-25df-417e-8126-e6bd6207e854" class="page sans"><header><img class="page-cover-image" src="https://www.notion.so/images/page-cover/met_silk_kashan_carpet.jpg" style="object-position:center 50%"/><div class="page-header-icon page-header-icon-with-cover"><span class="icon">🍉</span></div><h1 class="page-title">第二十二节:ETH-智能合约</h1></header><div class="page-body"><nav id="abfcd912-2500-4e9b-83aa-0a5c9496d642" class="block-color-gray table_of_contents"><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#80661257-0d8f-471f-bd3e-50b1431be390">22.1 什么是智能合约</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#727ef76a-74ea-462f-8d43-905bed947f2d">22.2 智能合约的代码结构</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#962882f6-d584-43a3-85ce-e56e429765e1">22.3 合约调用</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#8ce972a3-3f3b-4049-ba05-249f83b85ec1">22.3.1 外部账户如何调用智能合约？</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#584176de-963a-4de8-a0fa-676df41ac9d0">22.3.2 一个合约如何调用另一个合约中的函数？</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#8a06bfcb-af56-4c3d-a74f-581932150957">22.4 payable</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#d62cb71b-bfe0-4634-8a22-feb83b036cd8">22.5 fallback()函数</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#16a48276-bd58-410f-88bd-805a1ad05341">22.6 智能合约的创建和运行</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#0a0795d5-2d57-474f-98b0-31d561358593">22.6.1 创建合约</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#d1d4ad6b-78a2-4440-9d8d-8c3058839dd8">22.7 汽油费 gas fee</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#0d2dc634-fbb7-4ad8-84b2-94e95ca6c645">22.7.1 交易数据结构</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#66988918-cf5e-49d0-ad4a-f58976e5878c">22.7.2 执行</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#075c42fe-5a54-43b2-9716-2e2c574f6f21">22.8 错误处理</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#580e1e59-60d9-415d-a88d-7eb5e82211f4">22.9 嵌套调用</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#888ae258-aee7-48c8-bee0-4d430ca353cf">22.10 Block Header中的GasLimit和GasUsed</a></div></nav><hr id="80a1584a-abd7-4095-b427-dba6c232222f"/><p id="2de0594a-85c7-4416-8d8b-b3c2ded2166e" class="">
</p><p id="188f7989-8760-406b-90ca-f3d48654fe4a" class="">智能合约是以太坊的精髓，也是以太坊和比特币一个最大的区别</p><h2 id="80661257-0d8f-471f-bd3e-50b1431be390" class="">22.1 什么是智能合约</h2><p id="ebabccdb-819f-4d0c-b6e9-99cbb0f348eb" class="">智能合约的本质是运行在区块链上的一段代码，代码的逻辑定义了智能合约的内容。</p><p id="bfd086b8-bd6f-497c-92cc-a5cee343abb1" class="">智能合约的账户保存了合约当前的运行状态</p><p id="69adb40b-e664-46a0-a75d-f07c5b09a027" class="">balance：当前余额</p><p id="36a7e84c-f08e-4ba5-91e0-b96353af61a9" class="">nonce：交易次数</p><p id="ea243260-80e6-42cf-923d-46d649b5b834" class="">code：合约代码</p><p id="7a4f1a3d-278a-40fb-9a92-bf6cf995757d" class="">storage：存储，数据结构是一棵MPT</p><p id="3a98ff1d-4923-40cf-bcbc-a7815190c09a" class="">Solidity是智能合约最常用的语言，语法上与JavaScript很接近</p><h2 id="727ef76a-74ea-462f-8d43-905bed947f2d" class="">22.2 智能合约的代码结构</h2><figure id="cb2679a8-98aa-4e50-add0-7592b980560e" class="image"><a href="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image1.png"><img style="width:700px" src="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image1.png"/></a></figure><p id="8d0cc27d-9777-4d44-b888-0a5432470b4c" class="">Solidity是面向对象的编程语言，这里的contract类似于C++当中的类class，这里的contract定义了很多状态变量，Solidity是强类型语言，这里的类型跟普通的编程语言像C++之类的是比较接近的，比如说uint（unsigned int）是无符号的整数，address类型是Solidity语言所特有的</p><p id="6cdd4603-89c6-46d0-bc3d-50d246100d05" class="">接下来是两个event事件，作用是用来记录日志的</p><p id="2d4275e5-e57f-461a-9ce9-c50ff858d489" class="">第一个事件是HighestBidIncreased，拍卖的最高出价增加了，上图是一个网上拍卖的例子，如果有人出现新的最高价，记录一下参数是address bidder，金额是amount，第二个事件是Pay2Beneficiary，参数是赢得拍卖的人的地址winner以及他最后的出价amount</p><p id="4143bb3a-3bdf-4476-a6b5-f11fdf9569a8" class="">Solidity语言跟别的普通编程语言相比有一些特别之处：</p><p id="97e1fc1b-85a8-4546-bcc7-8d48a308ed34" class="">比如mapping，mapping是一个哈希表，保存了从地址到unit的一个映射。Solidity语言中哈希表不支持遍历，如果想遍历哈希表里的所有元素，需要自己想办法记录哈希表中有哪些元素，这里是用bidders数组来记录的。Solidity语言中的数组可以是固定长度的，也可以是动态改变长度的，这里是一个动态改变长度的数组。如果想在数组里增加一个元素，就用push操作，bidders.push(bidder)，新增加一个出价人在数组的末尾，要想知道这个数组有多少个元素，可以用bidders.length，如果是固定长度的数组的话，就要写明数组的长度，比如说address[1024]，这个就是长度为1024的数组</p><p id="6bc6132a-800c-4cc9-9bd4-09e697119597" class="">再往下是构造函数，构造函数只能有一个，Solidity语言中定义构造函数有两种方法：</p><p id="f57f80ea-a089-46e4-8c46-295ec8e55fae" class="">一种方法就是像C++构造函数一样，定一个与contract同名的函数，这个函数可以有参数，但是不能有返回值</p><p id="011b7fa1-44f8-46d1-8633-6ce38e78553d" class="">新版本Solidity语言更推荐用这个例子的方法，就用一个constructor来定义一个构造函数，这个构造函数只有在合约创建的时候会被调用一次</p><p id="0a554309-8663-4638-8d2a-f0b88bab9ada" class="">接下来是三个成员函数，三个函数都是public，说明其他账户可以调用这些函数</p><h2 id="962882f6-d584-43a3-85ce-e56e429765e1" class="">22.3 合约调用</h2><h3 id="8ce972a3-3f3b-4049-ba05-249f83b85ec1" class="">22.3.1 外部账户如何调用智能合约？</h3><figure id="65704175-12a4-468c-98bc-8bcb69e3fa13" class="image"><a href="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image2.png"><img style="width:700px" src="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image2.png"/></a></figure><p id="ac376e8c-8185-48f6-ab39-ed37f2b0e320" class="">调用智能合约其实跟转账是类似的，比如说A发起一个交易转账给B：</p><p id="48c5f285-0d16-472b-8c3e-d18072424470" class="">如果B是一个普通的账户，那么这就是一个普通的转账交易，就跟比特币当中的转账交易时一样的</p><p id="c9cc9bb9-29ef-4660-820a-a8e152564328" class="">如果B是一个合约账户的话，那么这个转账实际上是发起一次对B这个合约的调用，那么具体是调用合约中的哪个函数呢，是在data域（数据域）说明的</p><p id="4fb2977b-5259-43e5-87fc-2665d87a8cbf" class="">上图这个例子中，sender address是发起这个调用的账户的地址，to contract address是被调用的合约的地址，调用的函数是txdata，如果函数是有参数的话，那么参数的取值也是在data域里说明的，上面看的网上拍卖的例子中，三个成员函数都没有参数，但是有的成员函数是可以有参数的</p><p id="6af50cb7-894d-4050-be9d-32e88f5a68b0" class="">中间那一行是调用的参数，value是说发起调用的时候转过去多少钱，这里是0，这个调用的目的仅仅是为了调用它的函数，并不是真的要转帐，所以value=0，gas used是这个交易花了多少汽油费，gas price是单位汽油的价格，gas limit是这个交易我最多原意支付多少汽油费</p><h3 id="584176de-963a-4de8-a0fa-676df41ac9d0" class="">22.3.2 一个合约如何调用另一个合约中的函数？</h3><p id="45601109-6c1b-454e-be22-c59f3b9a8eb0" class=""><strong>方法一：直接调用</strong></p><figure id="a1014d60-2595-4852-bd16-40553472ce99" class="image"><a href="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image3.png"><img style="width:700px" src="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image3.png"/></a></figure><p id="d6091929-5172-43d5-ba4d-b1d7f421b5fa" class="">上图这个例子中，有A和B两个合约：</p><p id="b5d8c4ef-744f-403d-9aa4-827524031fce" class="">A这个合约就只是写log，event定义事件LogCallFoo，<strong>emit LogCallFoo()</strong>是用emit这个操作来调用这个事件，emit语句的作用就是写一个log，对于程序的运行逻辑是没有影响的</p><p id="faceb486-de2d-4750-9108-bc127b6fdff2" class="">B这个合约，callAFooDirectly这个函数参数是一个地址，就是A这个合约的地址，然后就这个语句把这个地址转换成A这个合约的一个实例，然后调用其中的foo这个函数</p><p id="4254e682-7a07-4fae-bdcc-5b494bf13ede" class=""><strong>以太坊中规定一个交易只有外部账户才能够发起，合约账户不能自己主动发起一个交易。</strong>所以这个例子中需要有一个外部账户调用了合约B当中的这个callAFooDirectly函数，然后这个函数再调用合约A当中的foo函数</p><p id="3958982d-5210-4b3a-a6a8-7d9bdf9044c1" class=""><strong>方法二：使用address类型的call()函数</strong></p><figure id="973ef2b6-d0da-4f71-b0cb-b63bc799efee" class="image"><a href="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image4.png"><img style="width:700px" src="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image4.png"/></a></figure><p id="72e09d87-45a1-48f5-983b-75cf099d1da5" class="">address类型的call()函数，第一个参数是要调用函数的签名，然后后面跟的是调用的参数</p><p id="762e9ecf-5f22-4b21-b897-d68f4599d7ec" class="">这种调用的方法跟上一个调用的方法相比，一个区别是对于错误处理的不同，<strong>直接调用时，如果你调用了那个合约在执行过程中出现错误，那么会导致发起调用的这个合约也跟着一起回滚</strong>，在直接调用的例子中如果A在执行过程出现什么异常，会导致B这个合约也跟着一起出错.</p><p id="3ce6c1f5-a252-46b0-95f0-954e76efbfa0" class="">而这种<strong>address.call()这种形式如果在调用过程中，被调用的合约抛出异常，那么这个call函数会返回false，表明这个调用是失败的，但是发起调用的这个函数并不会抛出异常，而是可以继续执行</strong></p><p id="d1979b2f-982a-437d-aba7-d0d536f55e40" class=""><strong>方法三：代理调用delegatecall()</strong></p><figure id="7fd7e44a-918b-4b7f-a3ba-694fbe152b77" class="image"><a href="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image5.png"><img style="width:700px" src="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image5.png"/></a></figure><p id="6e8bea94-1fbc-46cc-9503-dca50115b804" class="">代理调用和call()这种方法基本上是一样的，一个主要的区别是delegatecall不需要切换到被调用的合约的环境中去执行，而是在当前合约环境中执行就可以了，比如就用当前账户的账户余额存储之类的</p><h2 id="8a06bfcb-af56-4c3d-a74f-581932150957" class="">22.4 payable</h2><figure id="77c563be-cdfe-4044-ad5e-f43134aa0f12" class="image"><a href="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image6.png"><img style="width:700px" src="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image6.png"/></a></figure><p id="4a3ae897-0506-4266-b5ea-34df0bf415af" class="">上图中，bid函数有一个payable，另外两个函数都没有。以太坊中规定如果这个合约账户要能接收外部转账的话，那么必须标注成payable</p><p id="358c6d94-6b31-4326-9d3d-bdb97c4b68fd" class="">这个例子中bid函数是什么意思？</p><p id="e48384d5-9fed-4d3a-ad90-a1ef708d0155" class="">这是一个网上拍卖的合约，bid函数是用来进行竞拍出价的，比如说你要参与拍卖，你说你出100个以太币，那么就调用合约当中的bid函数。拍卖规则是调用bid函数时要把拍卖的出价100个以太币也发送过去，存储到这个合约里，锁定到拍卖结束，避免有人凭空出价，所以这个bid函数要有能够接收外部转账的能力，才标注一个payable</p><p id="18c4ca35-64bf-4ed2-a786-873c0d1430a0" class="">第二个withdraw函数没有payable，withdraw是拍卖结束了，出价最高的那个人赢得了拍卖，其他人没有拍到想要的东西，可以调用withdraw把自己当初出的价钱，就是原来bid的时候锁定在智能合约里的以太币再取回来，因为这个的目的不是为了真的转账，不是要把钱转给智能合约，而仅仅是调用withdraw函数把当初锁定在智能合约里的那一部分钱取回来，所以没必要标注payable</p><figure id="ce8db96a-e627-4414-959e-9abf04cdf50b" class="image"><a href="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image7.png"><img style="width:700px" src="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image7.png"/></a></figure><p id="d7e4af44-41e1-4b2e-a51b-51abafe02c55" class="">上图转账交易的例子，value=0，这个交易就属于并没有真的把钱转出去，所以to contract address这个函数就不用定义成payable</p><p id="7a4b94fe-9251-486b-881e-b94f0236e33e" class="">以太坊中凡是要接收外部转账的函数，都必须标识为payable，否则你给这个函数转出钱的话，会引发错误处理，会抛出异常，如果你不需要接收外部转账你就不用标识为payable</p><h2 id="d62cb71b-bfe0-4634-8a22-feb83b036cd8" class="">22.5 fallback()函数</h2><figure id="73471a97-9ba2-41c7-8801-991e0a4dff51" class="image"><a href="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image8.png"><img style="width:700px" src="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image8.png"/></a></figure><p id="7589fd5b-2095-4a38-9dc5-1965e32410e2" class="">有一个特殊的函数叫fallback()函数，这个函数既没有参数也没有返回值，而且也没有函数名是个匿名函数，这个fallback关键字也没有出现在这个函数名里。</p><p id="c0ee8d86-2943-431a-beaf-cf437084de9f" class="">调用合约的时候，A调用B这个合约，然后要在转账交易的data域说明你调用的是B当中的哪个函数，如果A给合约B转账了一笔钱，没有说明调用的是哪个函数，它的data域是空的，那怎么办呢？那么这个时候缺省的就是调用这个fallback()函数，为什么叫fallback()函数，因为没有别的函数可调了，就调它。</p><p id="b1047d04-8583-41f5-a53d-dbcbcfaf2738" class="">还有一种情况是你要调的函数不存在，在那个data域里，你说要调这个函数，而实际这个合约当中没有这个函数，那怎么办呢？也是调用这个fallback()函数。这就是为什么这个函数没有参数也没有返回值，因为它没法提供参数。</p><p id="589a0865-471f-46d3-b0df-aca208f5dd6f" class="">对于fallback()函数来说，也可能需要标注payable关键字，如果fallback()函数需要有接收转账的能力的话，也需要写成是payable，一般情况下，都是写上payable的，如果合约账户没有任何函数标识为payable，包括fallback()函数函数也没有标识成payable，那么这个合约没有任何能力接受外部的转账。如果这个合约没有fallback()函数或者是有fallback()函数但是没有写payable，那么其他人往这个合约里转一笔钱，别的都不说，data域是空的就会引发异常</p><p id="7b63a9d8-ca3f-4516-a426-1bfdc270a5b7" class="">fallback()函数不是必须定义的，合约里可以没有fallback()函数，如果没有fallback()函数的话，出现前面说的几种情况，就会抛出异常。另外只有合约账户才有这些东西，外部账户跟这个都没有关系，外部账户都没有代码</p><p id="461eec36-ef2e-4d00-8cbe-917374f3f302" class="">还有一点，转账金额可以是0，但是汽油费是要给的，这是两码事，转账金额是给收款人的，汽油费是给发布这个区块的矿工的，如果汽油费不给的话，矿工不会把你这个交易打包发布到区块链</p><h2 id="16a48276-bd58-410f-88bd-805a1ad05341" class="">22.6 智能合约的创建和运行</h2><figure id="29d57fc9-749b-4da9-b81a-de924f8a46df" class="image"><a href="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image9.png"><img style="width:700px" src="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image9.png"/></a></figure><h3 id="0a0795d5-2d57-474f-98b0-31d561358593" class="">22.6.1 创建合约</h3><p id="8a34cfb9-0f86-42fd-861d-1d71f1f55d1c" class="">智能合约是怎么创建的呢？是由一个外部账户发起一个转账交易，转给0x0这个地址，然后把这个要发布合约的代码放到data域里面。你要创建一个合约，要发起一个转账交易，给0这个地址转账，转账的金额都是0，因为你实际上不是真的想转帐，只是想发布一个智能合约，发布的这个智能合约的代码放到数据域就行了。</p><p id="22014776-9548-42c7-89d4-1e798a8554d6" class="">合约的代码写完之后都是要编译成bytecode，然后运行在EVM上。EVM是类似于JVM的设计思想，通过加一层虚拟机，对智能合约的运行提供一个一致性的平台，所以EVM有时叫做Worldwide Computer（全世界的一个计算机），EVM的寻址空间是非常大，是256位，像前面讲的unsigned int就是256位。</p><h2 id="d1d4ad6b-78a2-4440-9d8d-8c3058839dd8" class="">22.7 汽油费 gas fee</h2><figure id="a581c154-ee04-4443-8095-deaed3231afc" class="image"><a href="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image10.png"><img style="width:700px" src="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image10.png"/></a></figure><p id="04cce260-d5af-47d2-b6ea-16393bb2ee19" class="">比特币和以太坊这两种区块链的编程模型，设计理念是有很大差别的</p><p id="4de309c4-65ad-4d18-9c78-7c5a6cefc38a" class="">比特币设计理念是简单，脚本语言的功能很有限，比如说不支持循环</p><p id="bbdeeda3-544f-490e-a731-07366900b9a3" class="">而以太坊是要提供一个图灵完备的编程模型（Turing-complete Programming Model），很多功能在比特币平台上实现起来很困难，甚至是根本实现不了，而到以太坊平台上呢，实现起来就很容易，当然，这样也带来一个问题，出现死循环怎么办，当一个全节点收到一个对智能合约的调用，怎么知道这个调用执行起来会不会导致死循环？有什么办法吗？</p><p id="57e1ac78-8fe9-473c-9e76-ec9f33ae7533" class="">没有办法，这实际上是一个Halting Problem（停机问题），停机问题是不可解的，从理论上可以证明不存在这样一个算法，能够对任意给定的输入程序判断出这个程序是否会停机。那怎么办呢？办法就是把这个问题推给发起交易的那个账户，<strong>以太坊引入了汽油费机制，发起一个对智能合约的调用要支付相应的汽油费。</strong></p><h3 id="0d2dc634-fbb7-4ad8-84b2-94e95ca6c645" class="">22.7.1 交易数据结构</h3><figure id="71caa331-edae-499b-8da9-ddaf8fb18b12" class="image"><a href="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image11.png"><img style="width:622px" src="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image11.png"/></a></figure><p id="94be99bf-9c79-4f0f-816d-dc83d9f0f3eb" class="">上图中间是一个交易的数据结构：</p><p id="55cf8e93-5e9c-464a-8eab-e12015df84b6" class="">AccountNonce就是这个交易的序号，用于防止replay attack</p><p id="3b92beab-16e7-4ba1-b7a3-90bf2aa51c9a" class="">Price和GasLimit就是跟汽油费相关的，GasLimit是这个交易原意支付的最大汽油量，Price是单位汽油的价格，两个乘在一起就是这个交易可能消耗的最大汽油费</p><p id="dab7c8f4-7971-4507-9831-357c90779a20" class="">Recipient就是收款人的地址，转账交易转给谁的收款人地址</p><p id="11bcd89c-0002-43b4-8b80-933973c6c7f0" class="">Amount是转账金额，把Amount这么多钱转给Recipient，也可以看到交易当中的汽油费跟转账金额是分开的</p><p id="770e01f1-8c6e-477a-884f-b65db52541e4" class="">Payload就是前面说的data域，用于存放调用的是合约中的哪一个函数，函数的参数取值是什么，都在Payload里面</p><h3 id="66988918-cf5e-49d0-ad4a-f58976e5878c" class="">22.7.2 执行</h3><p id="e70ec6ab-02da-426a-90f6-f7d5eb873470" class=""><strong>当一个全节点收到一个对智能合约的调用的时候，先按照调用过程中给出的GasLimit算出可能花掉的最大汽油费，然后一次性的把这个汽油费从这个发起调用的账户上扣掉，然后再根据实际执行的情况，算出实际花了多少钱，如果汽油费不够的会引起回滚</strong></p><p id="255b623d-8e95-4379-8978-e0d1d817d47b" class="">不同的指令消耗的汽油费是不一样的。一些简单的指令，比如说加法减法消耗的汽油费是很少的，复杂的指令消耗的汽油费就比较多，比如说取哈希，这个运算一条指令就可以完成，但是汽油费就比较贵，除了计算量之外，需要存储状态的指令消耗的汽油费也是比较大的，那么相比之下，如果仅仅是为了读取公共数据，那么那些指令可以是免费的</p><h2 id="075c42fe-5a54-43b2-9716-2e2c574f6f21" class="">22.8 错误处理</h2><figure id="9959ad59-d609-4813-89cb-081f8552c885" class="image"><a href="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image12.png"><img style="width:700px" src="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image12.png"/></a></figure><p id="85579033-0791-4c80-90c6-e0e718637ef0" class=""><strong>以太坊中的交易执行起来具有原子性，一个交易要么全部执行，要么完全不执行，不会只执行一部分</strong>，这个交易既包含普通的转账交易，也包含对智能合约的调用，所以<strong>如果在执行智能合约的过程当中，出现任何错误，会导致整个交易的执行回滚</strong>，退回到开始执行的之前的状态，就好像这个交易完全没有执行过</p><p id="17359844-68b4-4288-99cc-25543a76827a" class="">那么什么情况下会出现错误呢？</p><p id="d567c711-44de-4e09-864f-439d24a1f4be" class="">一种情况就是刚才说的汽油费，如果这个交易执行完之后，没有达到当初的GasLimit，那么多余的汽油费会被退回到这个账户里，一开始的时候是按照最大的GasLimit把汽油费扣掉了，如果最后运行完了，还有剩下来的，实际上是用的多少汽油收多少钱，剩的可以退回去。相反，<strong>如果执行到一半，GasLimit已经都用完了，那么这个时候这个合约的执行要退回到开始执行之前的状态，这就是一种错误处理，而且这个时候已经消耗掉的汽油费是不退的。</strong></p><p id="add69d64-ed8e-4c47-8ebe-2a6c7418087c" class="">为什么要这么设计呢？执行的状态要回滚，但已经耗掉的汽油费是不退的</p><p id="09a1e89b-2c16-4ac5-a9f8-023c55421726" class="">因为要么的话就会有恶意的节点可能会发动delays service attack，可能他发布一个计算量很大的合约，然后不停的调这个合约，每次调的时候给的汽油费都不够，反正最后汽油费还会退回来，那么对攻击者来说没有什么损失，但是对矿工来说是白白浪费了很多的资源，这就是为什么说，汽油费不够的话，执行到一半会回滚，花掉的汽油费是不退的</p><p id="422c5db9-5f7c-4f45-a009-ab8f10707554" class="">除了这种汽油费不够的情况，还有一种情况是引起错误处理的，比如说<strong>assert语句和require语句，这两个语句都是用来判断某种条件，如果条件不满足的话，就会导致抛出异常。</strong></p><p id="ff52451a-7975-4ad9-a9cd-e009abd95b35" class=""><strong>assert语句一般用于判断某种内部条件</strong>，有点像C语言中的assert是一样的，require语句一般用于判断某种外部条件，比如说判断函数的输入是否符合要求。上图中给出了一个简单的例子，bid这个竞拍的函数判断一下，当前的时间now&lt;=拍卖的结束时间auctionEnd，如果符合条件继续执行，如果不符合的话，拍卖都已经结束了，你还在出价，这个时候就会抛出异常</p><p id="882acf3b-0809-4029-b538-3945af25b0ea" class="">第三个语句是revert，<strong>revert是无条件的抛出异常，如果执行到revert语句，那么自动的就会导致回滚</strong>，早期的版本里用的是throw语句，新版本Solidity里建议改用revert这个语句</p><p id="a67f85d5-ef1f-4612-95c0-bb94dc7d3b91" class=""><strong>Solidity当中没有这种try-catch这种结构</strong>，有的编程语言像Java，用户自己可以定义出现问题后怎么办，有这种try-catch，Solidity里没有这种结构。</p><h2 id="580e1e59-60d9-415d-a88d-7eb5e82211f4" class="">22.9 嵌套调用</h2><figure id="b185f5c2-cdc0-4b24-8079-bd2e04a517cf" class="image"><a href="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image13.png"><img style="width:700px" src="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image13.png"/></a></figure><p id="12b75a9d-b458-41af-ade5-a727af2b9a42" class="">智能合约出现错误会导致回滚，那么如果是嵌套调用，一个智能合约调用另外一个智能合约，那么被调用的这个智能合约出现错误，是不是会导致发起调用的智能合约，也跟着一起回滚呢？所谓的叫<strong>连锁式回滚</strong></p><p id="4eb51419-6bc3-4977-8e04-cdc5d0db2eb4" class="">不一定，<strong>这个取决于调用这个智能合约的方式。如果是直接调用的话，会出现连锁式的回滚，整个交易都会回滚，如果调用的方式是用比如说call这种方式，就不会引起连锁式回滚，只会使当前的调用失败返回一个false的返回值</strong></p><p id="915960e1-e9d8-4845-98b3-9eca6de0f2d3" class="">有些情况下，从表面上看你并没有调用任何一个函数，比如说，你就是往一个账户里转账，但是这个账户是合约账户的话，转账这个操作本身就有可能触发对函数的调用，因为有fallback()函数，这就是一种嵌套调用，一个合约往另一个合约里转账，就有可能调用这个合约里的fallback函数</p><h2 id="888ae258-aee7-48c8-bee0-4d430ca353cf" class="">22.10 Block Header中的GasLimit和GasUsed</h2><figure id="bae9dc70-e72d-4c7b-853b-fc686e95da1b" class="image"><a href="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image14.png"><img style="width:700px" src="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image14.png"/></a></figure><p id="ecaf9493-6254-4e82-9351-f7f28e26a16f" class="">Block Header中的GasLimit和GasUsed也是跟汽油费相关的，</p><p id="814b50e7-4583-4ae8-a198-b4d0da89133b" class=""><strong>Block Header里面的GasUsed是这个区块里所有交易所消耗的汽油费加在一起。</strong></p><p id="7875cbac-9c56-4d3a-9b01-1289776d667d" class="">发布区块需要消耗一定的资源，这个消耗的资源要不要有一个限制，比特币当中对于发布的的区块也是有一个限制的，大小的限制，最多不能超过1M，因为发布的区块如果没有任何限制，有的矿工可能把特别多的交易全部打包到一个区块里面然后发布出去，那么这个超大的区块在区块链上会消耗很多资源，所以它规定每个区块最多不能超过1M，比特币交易是比较简单的，基本上可以用交易的字节数来衡量出这个交易消耗的资源有多少，但以太坊中如果这么规定是不行的，因为以太坊中智能合约的逻辑很复杂，有的交易可能从字节数上看是很小的，但它消耗的资源可能很大，比如它可能调用别的合约之类的，所以<strong>要根据交易的具体操作来收费，这就是汽油费。</strong></p><p id="6cf88ecf-4371-4ba0-97da-7ce4a9963032" class=""><strong>Block Header里面的GasLimit是这个区块里所有交易能够消耗的汽油的一个上限</strong>，不是说把区块里每个交易的GasLimit加在一起，如果那样的话，就等于没有限制了，因为每个交易的GasLimit是发布这个交易的账户自己定的，定多少是自己说了算，但是这个区块中的所有交易，实际能够消耗的汽油是有一个上限的，不能无限的消耗，否则你也可能发布一个对资源消耗很大的区块，对整个系统的运行是没有好处的。</p><figure id="310fb531-b0ac-4c9c-bca4-8c022138b4d7" class="image"><a href="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image15.png"><img style="width:700px" src="%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%BA%8C%E8%8A%82%20ETH-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%20b03b539f25df417e8126e6bd6207e854/image15.png"/></a></figure><p id="dc3ab945-2803-4f32-a53b-41b059a1546c" class="">GasLimit跟比特币的区别：</p><p id="cb8cfb41-8902-4981-a821-13fbbd69f8be" class="">比特币限制资源是按照大小来限制的，而且这个1M的上限是固定了的，是写死在协议里面的，有些人认为1M太小了，而且有的分叉币的产生就是为了提高这个上限</p><p id="19f6ca56-b2a2-4004-824f-46aa2e2918f8" class="">以太坊中也有一个上限，这个GasLimit，但是<strong>每个矿工在发布区块的时候可以对GasLimit进行微调，可以在上一个GasLimit的基础上上调或者下调</strong>1/1024。如果出现像比特币那种情况，大家都觉得这个GasLimit设置的太小了，那轮到你发布区块的时候可以增加1/1024, 1/1024听起来很小，以太坊的出块速度很快，十几秒就是一个新的区块，所以的话，如果大家都觉得当前的GasLimit太小，那么很快就可以翻一番。当然，也可能下调，有矿工认为GasLimit太大了需要下调，所以这种机制实际上求出的GasLimit，是所有矿工认为比较合理的GasLimit的一个平均值，有的矿工认为要上调，有的矿工认为要下调，那么每个矿工在获得记账权之后就按照自己的意愿进行这种上调或者下调的微调，所以最后整个系统的GasLimit就趋向于所有矿工的一个平均意见。</p><p id="6eb5edb7-1068-4dd1-a9b8-a4bf11abb87c" class="">
</p></div></article></body></html>